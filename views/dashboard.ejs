<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Formablog</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <script>
        function getContrastYIQ(hexcolor) {
            if (!hexcolor) return '#1d1d1f';
            hexcolor = hexcolor.replace("#", "");
            const r = parseInt(hexcolor.substr(0, 2), 16);
            const g = parseInt(hexcolor.substr(2, 2), 16);
            const b = parseInt(hexcolor.substr(4, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#1d1d1f' : '#ffffff';
        }

        function updateLivePreview(picker, containerId, isEdit = false) {
            const color = picker.value;
            const container = document.querySelector(`#${containerId} .modal-content`);
            const label = document.getElementById(isEdit ? 'editColorValue' : 'createColorValue');

            if (label) label.textContent = color.toUpperCase();

            if (container && (!isEdit || document.getElementById('editMode').style.display === 'block')) {
                const textColor = getContrastYIQ(color);
                container.style.backgroundColor = color;
                container.style.color = textColor;

                container.querySelectorAll('h1, h2, label, span, input, textarea, select, .post-date, .post-author, .comments-title, .modal-body').forEach(el => {
                    if (!el.classList.contains('submit-post-btn') && !el.closest('.comment-form')) {
                        el.style.color = 'inherit';
                    }
                });
            }
        }
    </script>
</head>

<body>
    <nav class="navbar">
        <div class="nav-content">
            <a href="/dashboard" class="logo">Formablog</a>
            <div class="nav-actions">
                <a href="/perfil" class="profile-link">
                    <img src="<%= user.foto_perfil || '/img/default-avatar.png' %>" alt="Perfil" class="nav-avatar">
                    <span>
                        <%= user.nombre %>
                    </span>
                </a>
                <a href="/logout" class="logout-link">Cerrar sesi√≥n</a>
            </div>
        </div>
    </nav>

    <main class="dashboard-container">
        <header class="welcome-section">
            <h1>Explorar</h1>
            <p>Bienvenido de nuevo, <%= user.nombre %>.</p>
        </header>

        <section class="feed">
            <% if (publicaciones.length> 0) { %>
                <% publicaciones.forEach(post=> { %>
                    <% const hex=(post.color_caja || '#ffffff' ).replace("#", "" ); const r=parseInt(hex.substr(0, 2),
                        16); const g=parseInt(hex.substr(2, 2), 16); const b=parseInt(hex.substr(4, 2), 16); const
                        yiq=((r * 299) + (g * 587) + (b * 114)) / 1000; const textColor=(yiq>= 128) ? '#1d1d1f' :
                        '#ffffff';
                        %>
                        <article class="post-card"
                            style="background-color: <%= post.color_caja || '#ffffff' %>; color: <%= textColor %>;"
                            onclick="openModal('<%= post.id_publicacion %>', '<%= post.titulo.replace(/'/g, '&#39;') %>', '<%= post.autor %>', '<%= post.autor_id %>', '<%= post.categoria %>', '<%= post.contenido.replace(/\n/g, '<br>').replace(/'/g, '&#39;') %>', '<%= new Date(post.fecha_publicacion).toLocaleDateString() %>', '<%= user.id %>', '<%= post.color_caja || '#ffffff' %>')">

                            <div class="post-header">
                                <span class="category-tag" style="border: 1px solid currentColor;">
                                    <%= post.categoria %>
                                </span>
                            </div>
                            <h2>
                                <%= post.titulo %>
                            </h2>
                            <p class="post-excerpt">
                                <%= post.contenido %>
                            </p>
                            <div class="post-footer">
                                <div class="interactions">
                                    <% if (user.id !=post.autor_id) { %>
                                        <form action="/publicacion/like/<%= post.id_publicacion %>" method="POST"
                                            style="display:inline;" onclick="event.stopPropagation();">
                                            <button type="submit" class="interaction-btn">‚ù§Ô∏è <%= post.total_megusta %>
                                            </button>
                                        </form>
                                        <% } else { %>
                                            <span class="interaction-stat">‚ù§Ô∏è <%= post.total_megusta %></span>
                                            <% } %>
                                                <span class="interaction-stat">üí¨ <%= post.total_comentarios %></span>
                                </div>
                                <span class="post-author">@<%= post.autor %></span>
                            </div>
                        </article>
                        <% }) %>
                            <% } else { %>
                                <p class="empty-msg">No hay publicaciones disponibles.</p>
                                <% } %>
        </section>
    </main>

    <button class="fab" onclick="openCreateModal()">+</button>

    <div id="postModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal()">&times;</button>

            <div id="viewMode">
                <div class="post-header">
                    <span id="modalCategory" class="category-tag" style="border: 1px solid currentColor;"></span>
                </div>
                <div class="title-row">
                    <h1 id="modalTitle"></h1>
                    <span class="post-author" id="modalAuthor"></span>
                </div>
                <div id="modalBody" class="modal-body"></div>

                <section class="comments-section">
                    <h3 class="comments-title">Comentarios</h3>
                    <form id="commentForm" method="POST" class="comment-form">
                        <textarea name="texto" placeholder="Escribe un comentario..." required></textarea>
                        <div class="comment-form-footer">
                            <button type="submit" class="submit-post-btn">Enviar</button>
                        </div>
                    </form>
                    <div id="commentsList" class="comments-list"></div>
                </section>

                <div class="modal-actions-bar">
                    <span id="modalDate" class="post-date"></span>
                    <div id="adminActions" style="display: none; gap: 15px;">
                        <button onclick="showEditForm()" class="interaction-btn"
                            style="font-weight: 600;">Editar</button>
                        <form id="deleteForm" method="POST" style="display: inline;">
                            <button type="submit" class="interaction-btn" style="font-weight: 600; color: #ff3b30;"
                                onclick="return confirm('¬øEliminar esta publicaci√≥n?')">Eliminar</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="editMode" style="display: none;">
                <div class="create-post-card">
                    <h2>Editar publicaci√≥n</h2>
                    <form id="editPostForm" method="POST">
                        <div class="form-group">
                            <label>T√≠tulo</label>
                            <input type="text" name="titulo" id="editTitle" required>
                        </div>
                        <div class="form-group">
                            <label>Contenido</label>
                            <textarea name="contenido" id="editContent" rows="8" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Color de fondo</label>
                            <div class="color-picker-container">
                                <input type="color" name="color_caja" id="editColor"
                                    oninput="updateLivePreview(this, 'postModal', true)" required>
                                <span id="editColorValue">#FFFFFF</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="submit" class="submit-post-btn"
                                style="margin-top:0; flex: 2; filter: none; background: #0071e3; color: white;">Guardar
                                cambios</button>
                            <button type="button" onclick="hideEditForm()" class="submit-post-btn"
                                style="margin-top:0; flex: 1; background: #e5e5ea; color: #1d1d1f; filter: none;">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="createModal" class="modal-overlay" onclick="closeCreateModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeCreateModal()">&times;</button>
            <div class="create-post-card">
                <h2>Nueva publicaci√≥n</h2>
                <form action="/publicacion/crear" method="POST">
                    <div class="form-group">
                        <label>T√≠tulo</label>
                        <input type="text" name="titulo" placeholder="¬øSobre qu√© quieres escribir?" required>
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select name="id_categoria" required>
                            <% categorias.forEach(cat=> { %>
                                <option value="<%= cat.id_categoria %>">
                                    <%= cat.nombre %>
                                </option>
                                <% }) %>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Contenido</label>
                        <textarea name="contenido" rows="6" placeholder="Escribe aqu√≠ tu historia..."
                            required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Color de fondo</label>
                        <div class="color-picker-container">
                            <input type="color" name="color_caja" value="#ffffff" id="createColorPicker"
                                oninput="updateLivePreview(this, 'createModal')" required>
                            <span id="createColorValue">#FFFFFF</span>
                        </div>
                    </div>
                    <button type="submit" class="submit-post-btn"
                        style="filter: none; background: #0071e3; color: white;">Publicar ahora</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentPostColor = '#ffffff';

        async function openModal(id, titulo, autor, autorId, categoria, contenido, fecha, currentUserId, colorCaja) {
            hideEditForm();
            currentPostColor = colorCaja || '#ffffff';
            const modalContent = document.querySelector('#postModal .modal-content');
            const textColor = getContrastYIQ(currentPostColor);

            modalContent.style.backgroundColor = currentPostColor;
            modalContent.style.color = textColor;

            document.getElementById('modalTitle').innerText = titulo;
            document.getElementById('modalAuthor').innerText = '@' + autor;
            document.getElementById('modalCategory').innerText = categoria;
            document.getElementById('modalDate').innerText = fecha;
            document.getElementById('modalBody').innerHTML = contenido;

            const adminActions = document.getElementById('adminActions');
            if (currentUserId == autorId) {
                adminActions.style.display = 'flex';
                document.getElementById('deleteForm').action = '/publicacion/eliminar/' + id;
                document.getElementById('editPostForm').action = '/publicacion/editar/' + id;
                document.getElementById('editTitle').value = titulo;
                document.getElementById('editContent').value = contenido.replace(/<br>/g, '\n');
                document.getElementById('editColor').value = currentPostColor;
                document.getElementById('editColorValue').textContent = currentPostColor.toUpperCase();
            } else {
                adminActions.style.display = 'none';
            }

            document.getElementById('commentForm').action = '/publicacion/comentar/' + id;
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '<p>Cargando comentarios...</p>';

            try {
                const response = await fetch('/publicacion/comentarios/' + id);
                const comentarios = await response.json();
                commentsList.innerHTML = '';
                if (comentarios.length === 0) {
                    commentsList.innerHTML = `<p style="opacity: 0.6; font-size: 14px;">No hay comentarios a√∫n.</p>`;
                } else {
                    comentarios.forEach(c => {
                        const date = new Date(c.fecha_comentario).toLocaleDateString();
                        commentsList.innerHTML += `
                            <div class="comment-item">
                                <span class="comment-user">@${c.nombre}</span>
                                <p class="comment-text">${c.texto}</p>
                                <span class="comment-date">${date}</span>
                            </div>
                        `;
                    });
                }
            } catch (err) {
                commentsList.innerHTML = '<p>Error al cargar comentarios.</p>';
            }

            document.getElementById('postModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function showEditForm() {
            document.getElementById('viewMode').style.display = 'none';
            document.getElementById('editMode').style.display = 'block';
            updateLivePreview(document.getElementById('editColor'), 'postModal', true);
        }

        function hideEditForm() {
            document.getElementById('viewMode').style.display = 'block';
            document.getElementById('editMode').style.display = 'none';
            const modalContent = document.querySelector('#postModal .modal-content');
            const textColor = getContrastYIQ(currentPostColor);
            modalContent.style.backgroundColor = currentPostColor;
            modalContent.style.color = textColor;
        }

        function closeModal() {
            document.getElementById('postModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function openCreateModal() {
            const modal = document.getElementById('createModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            updateLivePreview(document.getElementById('createColorPicker'), 'createModal');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    </script>
</body>

</html>